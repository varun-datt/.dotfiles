#!/bin/sh

set -e

{{ if eq .chezmoi.os "windows" -}}

{{ else -}}
mkdir -p ~/sandbox

_tmux_plugins_directory="$HOME/.config/tmux/plugins/tpm"
_nvim_directory="$HOME/.config/nvim"

if [ ! -d "$_tmux_plugins_directory" ]; then
  git clone https://github.com/tmux-plugins/tpm "$_tmux_plugins_directory"
fi

if [ ! -d "$_nvim_directory" ]; then
 git clone --depth 1 https://github.com/AstroNvim/AstroNvim "$_nvim_directory"
fi

# fisher update

  # echo "RSA and DSA, at least 4096 bits, infinite expiry"
  # echo "user ID / email: Github email"

  # gpg --full-generate-key

  # gpg --list-secret-keys --keyid-format LONG

  # read -p "Enter key id: " _key_id

  # gpg --armor --export "${_key_id}"

  # # https://help.github.com/en/github/authenticating-to-github/adding-a-new-gpg-key-to-your-github-account

  # git config --global user.signingkey "${_key_id}"
  
  # git config commit.gpgsign true

{{ if eq .chezmoi.os "linux" -}}
pamac upgrade

_arch_packages="alacritty bat bitwarden broot chezmoi docker fd fish git git-delta github-cli lsd neovim ttf-jetbrains-mono-nerd obsidian ripgrep starship tldr tmux torbrowser-launcher veracrypt zoxide"
for _package in ${_arch_packages}; do
  if [ -z "$(pamac search -i $_package)" ]; then
    pamac install $_package
  fi
done

_aur_packages="brave-bin librewolf-bin mailspring notion-app visual-studio-code-bin"
for _package in ${_aur_packages}; do
  if [ -z "$(pamac search -i $_package)" ]; then
    pamac build $_package
  fi
done

# Gnome settings
gsettings set org.gnome.shell favorite-apps "['org.gnome.Nautilus.desktop', 'librewolf.desktop', 'Alacritty.desktop', 'bitwarden.desktop', 'obsidian.desktop', 'Mailspring.desktop', 'notion-app-enhanced.desktop']"

gsettings set org.gnome.nautilus.preferences show-hidden-files true
gsettings set org.gnome.desktop.interface show-battery-percentage true
gsettings set org.gnome.desktop.interface clock-show-weekday true

{{ else if eq .chezmoi.os "darwin" -}}

# Finder
defaults write com.apple.finder "AppleShowAllFiles" -bool "true"
defaults write com.apple.finder "ShowPathbar" -bool "true"
defaults write com.apple.finder "FXDefaultSearchScope" -string "SCcf" 
defaults write com.apple.finder "FXPreferredViewStyle" -string "Nlsv"
killall Finder

# Global
defaults write NSGlobalDomain "AppleShowAllExtensions" -bool "true"
defaults write NSGlobalDomain KeyRepeat -int 0
defaults write NSGlobalDomain InitialKeyRepeat -int 10

# Menu
defaults write com.apple.menuextra.clock "DateFormat" -string "\"EEE d MMM HH:mm:ss\"" 

# Dock
defaults write com.apple.dock "autohide" -bool "true" && killall Dock

# Brew install
brew bundle --file ~/Brewfile

{{ end -}}

_fish_path=$(which fish)
if [[ "$SHELL" != "${_fish_path}" ]]; then
  chsh -s $(which fish)
fi

{{ end -}}

